#Flood Frequency Analysis Using Methodology Outlined in Bulletin 17B

#Libraries
library("dataRetrieval", lib.loc="~/R/win-library/3.4")
library("zipfR", lib.loc="~/R/win-library/3.4")

#Retriving Data
siteNumber <- "03362000"  #USGS Number for Youngs Creek near Edinburgh, IN

#loading Peak Flow Data
peak_flow_data <- readNWISpeak(siteNumber, 
                               startDate = "", 
                               endDate = "", 
                               asDateTime = TRUE,
                               convertType = TRUE)
####K Values####
K_values <- data.frame(matrix(c(-2.00,-1.996,-0.609,0.307,0.777,0.895,0.959,0.980,0.990,0.995,
                                -1.90,-1.989,-0.627,0.294,0.788,0.920,0.996,1.023,1.307,1.044,
                                -1.80,-1.981,-0.643,0.282,0.799,0.945,1.035,1.069,1.087,1.097,
                                -1.70,-1.972,-0.660,0.268,0.808,0.970,1.075,1.116,1.140,1.155,
                                -1.60,-1.962,-0.675,0.254,0.817,0.994,1.116,1.166,1.197,1.216,
                                -1.50,-1.951,-0.690,0.240,0.825,1.018,1.157,1.217,1.256,1.282,
                                -1.40,-1.938,-0.705,0.225,0.832,1.041,1.198,1.270,1.318,1.351,
                                -1.30,-1.925,-0.719,0.210,0.838,1.064,1.240,1.324,1.383,1.424,
                                -1.20,-1.910,-0.732,0.195,0.844,1.086,1.282,1.379,1.449,1.501,
                                -1.10,-1.894,-0.745,0.180,0.848,1.107,1.324,1.435,1.518,1.581,
                                -1.00,-1.877,-0.758,0.164,0.852,1.128,1.366,1.492,1.588,1.664,
                                -0.90,-1.858,-0.769,0.148,0.854,1.147,1.407,1.549,1.660,1.749,
                                -0.80,-1.839,-0.780,0.132,0.856,1.166,1.448,1.606,1.733,1.837,
                                -0.70,-1.819,-0.790,0.116,0.857,1.183,1.488,1.663,1.806,1.926,
                                -0.60,-1.797,-0.800,0.099,0.857,1.200,1.528,1.720,1.880,2.016,
                                -0.50,-1.774,-0.808,0.083,0.856,1.216,1.567,1.777,1.955,2.108,
                                -0.40,-1.750,-0.816,0.066,0.855,1.231,1.606,1.834,2.029,2.201,
                                -0.30,-1.726,-0.824,0.050,0.853,1.245,1.643,1.890,2.104,2.294,
                                -0.20,-1.700,-0.830,0.033,0.850,1.258,1.680,1.945,2.178,2.388,
                                -0.10,-1.673,-0.836,0.017,0.846,1.270,1.716,2.000,2.252,2.482,
                                0.00,-1.645,-0.842,0.000,0.842,1.282,1.751,2.054,2.326,2.576,
                                0.10,-1.616,-0.846,-0.017,0.836,1.292,1.785,2.107,2.400,2.670,
                                0.20,-1.586,-0.850,-0.033,0.830,1.301,1.818,2.159,2.472,2.763,
                                0.30,-1.555,-0.853,-0.050,0.824,1.309,1.849,2.211,2.544,2.856,
                                0.40,-1.524,-0.855,-0.066,0.816,1.317,1.880,2.261,2.615,2.949,
                                0.50,-1.491,-0.856,-0.083,0.808,1.323,1.910,2.311,2.686,3.041,
                                0.60,-1.458,-0.857,-0.099,0.800,1.328,1.939,2.359,2.755,3.132,
                                0.70,-1.423,-0.857,-0.116,0.790,1.333,1.967,2.407,2.824,3.223,
                                0.80,-1.388,-0.856,-0.132,0.780,1.336,1.993,2.453,2.891,3.312,
                                0.90,-1.353,-0.854,-0.148,0.769,1.339,2.018,2.498,2.957,3.401,
                                1.00,-1.317,-0.852,-0.164,0.758,1.340,2.043,2.542,3.022,3.489,
                                1.10,-1.280,-0.848,-0.180,0.745,1.341,2.066,2.585,3.087,3.575,
                                1.20,-1.243,-0.844,-0.195,0.732,1.340,2.087,2.626,3.149,3.661,
                                1.30,-1.206,-0.838,-0.210,0.719,1.339,2.108,2.666,3.211,3.745,
                                1.40,-1.168,-0.832,-0.225,0.705,1.337,2.128,2.706,3.271,3.828,
                                1.50,-1.131,-0.825,-0.240,0.690,1.333,2.146,2.743,3.330,3.910,
                                1.60,-1.093,-0.817,-0.254,0.675,1.329,2.163,2.780,3.388,3.990,
                                1.70,-1.056,-0.808,-0.268,0.660,1.324,2.179,2.815,3.444,4.069,
                                1.80,-1.020,-0.799,-0.282,0.643,1.318,2.193,2.848,3.499,4.147,
                                1.90,-0.984,-0.788,-0.294,0.627,1.310,2.207,2.881,3.553,4.223,
                                2.00,-0.949,-0.777,-0.307,0.609,1.302,2.219,2.912,3.605,4.398,
                                2.10,-0.914,-0.765,-0.319,0.592,1.294,2.230,2.942,3.656,4.372,
                                2.20,-0.882,-0.752,-0.330,0.574,1.284,2.240,2.970,3.705,4.444,
                                2.30,-0.850,-0.739,-0.341,0.555,1.274,2.248,2.997,3.753,4.515,
                                2.40,-0.819,-0.725,-0.351,0.537,1.262,2.256,3.023,3.800,4.584,
                                2.50,-0.790,-0.711,-0.360,0.518,1.250,2.262,3.048,3.845,4.652,
                                2.60,-0.762,-0.696,-0.368,0.499,1.238,2.267,3.071,3.889,4.718,
                                2.70,-0.736,-0.681,-0.376,0.479,1.224,2.272,3.093,3.932,4.783,
                                2.80,-0.711,-0.666,-0.384,0.460,1.210,2.275,3.114,3.973,4.847,
                                2.90,-0.688,-0.651,-0.390,0.440,1.195,2.277,3.134,4.013,4.909,
                                3.00,-0.665,-0.636,-0.396,0.420,1.180,2.278,3.152,4.051,4.970),nrow=51,ncol=10,byrow=TRUE))
colnames(K_values) <- c("Cs","1.0526_yr" ,"1.25_yr" ,"2_yr","5_yr","10_yr" ,"25_yr" ,"50_yr","100_yr","200_yr")

K_lookup <- function(Cs) {
  Cs_round <- round(Cs,digits=1)
  K <- K_values[which(K_values$Cs==Cs_round),]
  return(K)
}
 
#Adding Rank and Plotting Position to Data
peak_flow_data$Rank <- rank(peak_flow_data$peak_va,ties.method="min")
n <- max(rank(peak_flow)) # number of records
peak_flow_data$PP <- (peak_flow_data$Rank)/(n+1) # Plotting Position


#Statistical Parameters
peak_flow <- peak_flow_data$peak_va
mean_peak_flow <- mean(log10(peak_flow)) # mean peak flow
S <- sqrt((1/(n-1))*sum((log10(peak_flow) - mean_peak_flow)^2)) # standard deviation of peak flow
G <- (n/((n-1)*(n-2)*S^3))*sum((log10(peak_flow)-mean_peak_flow)^3) # skew

#Getting the flood event data
flood.discharge <- function(mean_peak_flow,S,Cs) {
  K <- K_lookup(Cs)
  X_lpt <- mean_peak_flow +(S*K)
  flood <- 10^X_lpt
  return(flood[,c("1.0526_yr" ,"1.25_yr" ,"2_yr","5_yr","10_yr" ,"25_yr" ,"50_yr","100_yr","200_yr")])
}

flood.discharge(mean_peak_flow,S,G)

